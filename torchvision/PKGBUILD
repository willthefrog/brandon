# -*- mode: sh-mode; tab-width: 2; -*-
# Maintainer: Yang Zhang <yangzhang@live.com>
# Upstream URL: https://github.com/pytorch/vision

pkgbase=torchvision
pkgname=python-torchvision-cuda-git
pkgver=0.2.1.r29.gfe973ce
pkgrel=1
pkgdesc="Datasets, Transforms and Models specific to Computer Vision"
arch=('x86_64')
url="https://github.com/pytorch/vision"
license=('BSD')
provides=('python-torchvision')
conflicts=('python-torchvision')
replaces=('python-torchvision')
depends=('python-torch' 'python-six' 'python-pillow')
makedepends=('git' 'cmake' 'ninja' 'cuda' 'python-setuptools')
source=("${pkgbase}::git+$url.git")
md5sums=('SKIP')

pkgver() {
  cd "$pkgbase"
  echo "$(git log -1 --format="%cd" --date=short | sed 's|-||g').r$(git rev-list --count HEAD)".$(git describe --always | sed 's/.*-//g')
}

prepare() {
  cd "${pkgbase}"
  patch -p1  << __EOF__
--- a/torchvision/ops/boxes.py
+++ b/torchvision/ops/boxes.py
@@ -4,7 +4,6 @@ from torch import Tensor
 import torchvision


-@torch.jit.script
 def nms(boxes, scores, iou_threshold):
     # type: (Tensor, Tensor, float) -> Tensor
     """
@@ -41,7 +40,6 @@ def nms(boxes, scores, iou_threshold):
     return torch.ops.torchvision.nms(boxes, scores, iou_threshold)


-@torch.jit.script
 def batched_nms(boxes, scores, idxs, iou_threshold):
     # type: (Tensor, Tensor, Tensor, float) -> Tensor
     """
__EOF__
}

build() {
  cd "$pkgbase"
  MAX_JOBS=`nproc` \
  CC=/opt/cuda/bin/gcc \
  CXX=/opt/cuda/bin/g++ \
  FORCE_CUDA=1 \
  TORCH_CUDA_ARCH_LIST="5.0+PTX;6.1;7.0" \
  python setup.py build
}

package() {
  cd "$pkgbase"
  python setup.py install --skip-build --prefix=/usr --root="$pkgdir" --optimize=1
  install -m644 -D LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

# vim: set ts=2 sw=2:
