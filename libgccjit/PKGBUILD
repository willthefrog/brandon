# -*- mode: sh; tab-width: 2; -*-
# Maintainer: Yang Zhang <yangzhang@live.com>
# Upstream URL: http://gcc.gnu.org

_gccver=`pacman -Qi gcc | grep -oP "Version.*: \K([\d.]+)(?=-.)"`
_gccsrc="gcc-${_gccver}"

pkgname='libgccjit'
pkgver="${_gccver}"
pkgrel=`pacman -Qi gcc | grep -oP "Version.*: .*-\K([\d.]+)"`
pkgdesc='Just-In-Time Compilation using GCC.'
arch=(x86_64)
license=(GPL3)
url='https://gcc.gnu.org/wiki/JIT'
makedepends=(binutils libmpc mold)
depends=(glibc libmpc "gcc-libs=$pkgver")
options=('!emptydirs')
source=("ftp://gcc.gnu.org/pub/gcc/releases/$_gccsrc/$_gccsrc.tar.xz")
sha512sums=('SKIP')

prepare() {
  cd "$srcdir/$_gccsrc"

 # Do not run fixincludes
 sed -i 's@\./fixinc\.sh@-c true@' gcc/Makefile.in

 # Arch Linux installs x86_64 libraries /lib
 sed -i '/m64=/s/lib64/lib/' gcc/config/i386/t-linux64

 # hack! - some configure tests for header files using "$CPP $CPPFLAGS"
 sed -i "/ac_cpp=/s/\$CPPFLAGS/\$CPPFLAGS -O2/" {libiberty,gcc}/configure
}

build() {
  install -d "$srcdir/$pkgname-build"
  cd "$srcdir/$pkgname-build"

  CFLAGS="${CFLAGS/-Werror=format-security/} -fuse-ld=mold"
  CXXFLAGS="${CXXFLAGS/-Werror=format-security/} -fuse-ld=mold"
  ../$_gccsrc/configure \
     --libdir=/usr/lib \
     --libexecdir=/usr/lib \
     --mandir=/usr/share/man \
     --infodir=/usr/share/info \
     --with-bugurl=https://aur.archlinux.org/packages/libgccjit/ \
     --enable-languages=jit \
     --with-linker-hash-style=gnu \
     --with-system-zlib \
     --enable-__cxa_atexit \
     --enable-cet=auto \
     --enable-checking=release \
     --enable-clocale=gnu \
     --enable-default-pie \
     --enable-default-ssp \
     --enable-gnu-indirect-function \
     --enable-gnu-unique-object \
     --enable-install-libiberty \
     --enable-linker-build-id \
     --enable-lto \
     --enable-multilib \
     --enable-plugin \
     --enable-shared \
     --enable-host-shared \
     --enable-threads=posix \
     --disable-bootstrap \
     --disable-multilib \
     --disable-libssp \
     --disable-lto \
     --disable-libquadmath \
     --disable-liboffloadmic \
     --disable-libada \
     --disable-libsanitizer \
     --disable-libquadmath-support \
     --disable-libgomp \
     --disable-libvtv \
     --disable-libsanitizer \
     --disable-libstdcxx-pch \
     --disable-libunwind-exceptions \
     --disable-werror

  make -j`nproc`
}

package() {
  cd "$srcdir/$pkgname-build/gcc"
  make DESTDIR="$pkgdir" jit.install-common jit.install-info
}

post_install() {
  [[ -x usr/bin/install-info ]] || return 0
  install-info usr/share/info/libgccjit.info.gz usr/share/info/dir 2> /dev/null
}

# vim:set ft=sh ts=2 sw=2 et:
