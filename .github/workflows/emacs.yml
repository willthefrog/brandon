name: emacs
on:
  push:
    paths:
      - emacs/**
      - libgccjit/**
      - .github/workflows/emacs.yml
  repository_dispatch:
  schedule:
    - cron: '0 4 2 * *'

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      UPTOC_UPLOADER_AK: ${{ secrets.STORAGE_AK }}
      UPTOC_UPLOADER_SK: ${{ secrets.STORAGE_SK }}

    container:
      image: 'archlinux:base-devel'

    steps:
    - name: Checkout repository
      uses: actions/checkout@master

    - name: Setup user
      run: |
        useradd -Ums /bin/bash arch
        cat > /etc/sudoers.d/passwd <<__EOF__
        ALL ALL = (ALL) NOPASSWD: ALL
        __EOF__

    - name: Install packages
      run: pacman -Sy --noconfirm git gcc

    - name: Build and install libgccjit
      run: |
        chmod 777 -R .
        sudo -u arch makepkg -risf --noconfirm
      working-directory: libgccjit

    - name: Build emacs
      run: |
        chmod 777 -R .
        sudo -u arch makepkg -rsf --noconfirm
      working-directory: emacs

    - name: Upload libgccjit
      uses: saltbo/uptoc@master
      with:
        driver: google
        region: auto
        bucket: ${{ secrets.STORAGE_BUCKET }}
        dist: "libgccjit/*.zst"

    - name: Upload emacs
      uses: saltbo/uptoc@master
      with:
        driver: google
        region: auto
        bucket: ${{ secrets.STORAGE_BUCKET }}
        dist: "emacs/*.zst"
